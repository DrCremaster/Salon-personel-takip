<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Pro v7 - Esnek Takip</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        :root { --primary: #00d4ff; --bg: #0b0f19; --card: #161b2a; --text: #f8fafc; --accent: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 900px; background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #2d3748; margin-top: 10px; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #2d3748; padding-bottom: 10px; }
        .header h2 { color: var(--primary); margin: 0; font-size: 22px; text-transform: uppercase; }
        .hidden { display: none; }
        .active { display: block; animation: fadeIn 0.3s ease; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #2d3748; background: #0b0f19; color: white; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: 800; border: none; cursor: pointer; }
        .auto-btn { background: #3b82f6; color: white; margin-bottom: 15px; }
        .back-btn { background: transparent; color: #94a3b8; border: 1px solid #2d3748; }
        .analysis-card { background: #1e293b; padding: 15px; border-radius: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .stat-box { text-align: center; }
        .stat-box span { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üèãÔ∏è GYM MANAGEMENT</h2>
        <small id="subText" style="color:#94a3b8;">Esnek Mesai Takip Sistemi</small>
    </div>

    <div id="mainUI" class="step active">
        <button onclick="nav('staffLogin', 'Personel Giri≈üi')">PERSONEL Gƒ∞Rƒ∞≈ûƒ∞</button>
        <button class="back-btn" onclick="nav('bossLogin', 'Y√∂netici Giri≈üi')">PATRON PANELƒ∞</button>
    </div>

    <div id="staffLogin" class="step hidden">
        <select id="sName">
            <option value="" disabled selected>Personel Se√ßiniz...</option>
            <option>Ahmet</option><option>Mehmet</option><option>Ay≈üe</option>
        </select>
        <input type="password" id="sPass" placeholder="≈ûifreniz">
        <button onclick="authStaff()">Giri≈ü Yap</button>
        <button class="back-btn" onclick="nav('mainUI', 'Ho≈ü Geldiniz')">Geri</button>
    </div>

    <div id="staffForm" class="step hidden">
        <input type="text" id="dateSelect" placeholder="Tarih Se√ßin">
        
        <button class="auto-btn" onclick="setNow()">≈ûu Anki Saati Al (Giri≈ü/√áƒ±kƒ±≈ü)</button>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="tIn" class="tp" placeholder="Giri≈ü Saati">
            <input type="text" id="tOut" class="tp" placeholder="√áƒ±kƒ±≈ü Saati">
        </div>

        <input type="number" id="molaDk" placeholder="Mola (Dakika)">
        
        <div style="display: flex; gap: 10px;">
            <input type="text" id="borcAck" placeholder="Bor√ß Nedeni">
            <input type="number" id="borcFiyat" placeholder="Tutar (TL)">
        </div>

        <button id="saveBtn" onclick="submitData()">KAYDI TAMAMLA</button>
        <button class="back-btn" onclick="location.reload()">√áƒ±kƒ±≈ü</button>
    </div>

    <div id="bossLogin" class="step hidden">
        <input type="text" id="bUser" placeholder="Y√∂netici">
        <input type="password" id="bPass" placeholder="≈ûifre">
        <button onclick="authBoss()">Giri≈ü</button>
    </div>

    <div id="bossDashboard" class="step hidden">
        <select id="bossStaffFilter" onchange="filterCalendar()">
            <option value="HEPSƒ∞">T√ºm Personel</option>
            <option>Ahmet</option><option>Mehmet</option><option>Ay≈üe</option>
        </select>
        <div id="calendar"></div>
        <div class="analysis-card">
            <div class="stat-box"><small>Net S√ºre</small><span id="statNet">0s</span></div>
            <div class="stat-box"><small>Bor√ßlar</small><span id="statBorc">0 TL</span></div>
            <div class="stat-box"><small>Maa≈ü</small><span id="statMaas" style="color:#10b981">0 TL</span></div>
        </div>
        <button class="back-btn" onclick="location.reload()" style="margin-top:15px;">Kapat</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    const SHEETDB_URL = "https://sheetdb.io/api/v1/nzggrzkn4881m";
    const STAFF_DATA = {"Ahmet": "1111", "Mehmet": "2222", "Ay≈üe": "3333"};
    const BOSS_CREDS = {u: "admin", p: "gym2026"};
    const HOURLY_WAGE = 180;
    let allGlobalData = [];

    // Saat ayarƒ±: Hem manuel yazƒ±labilir hem de butona basƒ±nca otomatik dolar
    const fpConfig = { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, disableMobile: true, allowInput: true };
    flatpickr("#dateSelect", { locale: "tr", dateFormat: "d.m.Y", defaultDate: "today", disableMobile: true });
    flatpickr(".tp", fpConfig);

    function nav(id, text) {
        document.querySelectorAll('.step').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(text) document.getElementById('subText').innerText = text;
    }

    function authStaff() {
        const n = document.getElementById('sName').value;
        if(STAFF_DATA[n] === document.getElementById('sPass').value) nav('staffForm', `Ho≈ü geldin, ${n}`);
        else alert("≈ûifre Yanlƒ±≈ü!");
    }

    function setNow() {
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const inField = document.getElementById('tIn');
        const outField = document.getElementById('tOut');
        
        if(!inField.value) inField.value = time;
        else outField.value = time;
    }

    async function submitData() {
        const inT = document.getElementById('tIn').value;
        const outT = document.getElementById('tOut').value;
        if(!inT || !outT) return alert("Saatleri girin!");

        let diff = (new Date("2000-01-01 " + outT) - new Date("2000-01-01 " + inT)) / 3600000;
        if (diff < 0) diff += 24;
        const net = (diff - (document.getElementById('molaDk').value || 0)/60).toFixed(2);

        const data = {
            "Tarih": document.getElementById('dateSelect').value,
            "Isim": document.getElementById('sName').value,
            "BrutSure": diff.toFixed(2),
            "NetSure": net,
            "BorcA√ßƒ±klama": document.getElementById('borcAck').value || "-",
            "BorcTutar": document.getElementById('borcFiyat').value || 0
        };

        await fetch(SHEETDB_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({data: [data]}) });
        alert("Mesai Kaydedildi!");
        location.reload();
    }

    // Patron Dashboard Fonksiyonlarƒ±
    async function authBoss() {
        if(document.getElementById('bUser').value === BOSS_CREDS.u && document.getElementById('bPass').value === BOSS_CREDS.p) {
            nav('bossDashboard', 'Y√∂netici Paneli');
            const res = await fetch(SHEETDB_URL);
            allGlobalData = await res.json();
            initCalendar();
        } else alert("Hata!");
    }

    function initCalendar() {
        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth', locale: 'tr', selectable: true,
            select: info => calculateAnalysis(info.startStr, info.endStr)
        });
        calendar.render();
    }

    function calculateAnalysis(start, end) {
        let n = 0, br = 0;
        const filter = document.getElementById('bossStaffFilter').value;
        allGlobalData.forEach(d => {
            if(!d.Tarih) return;
            const [dd, mm, yy] = d.Tarih.split('.');
            const dDate = new Date(`${yy}-${mm}-${dd}`);
            if(dDate >= new Date(start) && dDate < new Date(end) && (filter === "HEPSƒ∞" || d.Isim === filter)) {
                n += parseFloat(d.NetSure) || 0;
                br += parseFloat(d.BorcTutar) || 0;
            }
        });
        document.getElementById('statNet').innerText = n.toFixed(1) + "s";
        document.getElementById('statBorc').innerText = br + " TL";
        document.getElementById('statMaas').innerText = ((n * HOURLY_WAGE) - br).toFixed(0) + " TL";
    }
</script>
</body>
</html>
